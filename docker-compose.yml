services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        GIT_COMMIT: ${GIT_COMMIT:-}
    container_name: gronka
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      # Docker-specific overrides (these take precedence over .env)
      - COBALT_API_URL=http://cobalt:9000
      - POSTGRES_HOST=postgres
    volumes:
      - ./.env:/app/.env:ro
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - '${SERVER_PORT:-3000}:${SERVER_PORT:-3000}'
      - '${WEBUI_PORT:-3001}:${WEBUI_PORT:-3001}'
    networks:
      - gronka-network
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  postgres:
    image: postgres:16-alpine
    container_name: gronka-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-gronka}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gronka}
      - POSTGRES_DB=${POSTGRES_DB:-gronka}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    networks:
      - gronka-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-gronka} -d ${POSTGRES_DB:-gronka}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  cobalt:
    image: ghcr.io/imputnet/cobalt:11
    init: true
    read_only: true
    restart: unless-stopped
    container_name: cobalt
    ports:
      # Exposed for internal Docker network access
      # If you want to restrict to localhost only, use: - 127.0.0.1:9000:9000/tcp
      - 9000:9000/tcp
    environment:
      API_URL: ${COBALT_API_URL:-http://cobalt:9000}
      # Path to cookies.json file for authenticating with services (Twitter, Instagram, Reddit, etc.)
      # Required for accessing content that requires authentication
      COOKIE_PATH: '/cookies.json'
    labels:
      - com.centurylinklabs.watchtower.scope=cobalt
    networks:
      - gronka-network
    volumes:
      # Mount cookies.json from project root to enable authentication for restricted content
      # Create cookies.json from cookies.example.json and add your service authentication cookies
      - ./cookies.json:/cookies.json

  giflossy:
    image: dylanninin/giflossy:latest
    container_name: giflossy
    restart: unless-stopped
    volumes:
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
    networks:
      - gronka-network
    # Note: This service is used for GIF optimization via docker exec

  # watchtower updates the cobalt image automatically
  watchtower:
    image: ghcr.io/containrrr/watchtower:latest
    restart: unless-stopped
    command: --cleanup --scope cobalt --interval 900 --include-restarting
    environment:
      - DOCKER_API_VERSION=1.52
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - gronka-network

  # if needed, use this image for automatically generating poToken & visitor_data
  # yt-session-generator:
  #   image: ghcr.io/imputnet/yt-session-generator:webserver
  #   init: true
  #   restart: unless-stopped
  #   container_name: yt-session-generator
  #   labels:
  #     - com.centurylinklabs.watchtower.scope=cobalt
  #   networks:
  #     - gronka-network

volumes:
  postgres-data:
    driver: local

networks:
  gronka-network:
    driver: bridge
