services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        GIT_COMMIT: ${GIT_COMMIT:-}
    container_name: gronka
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DISCORD_TOKEN=${PROD_DISCORD_TOKEN:-${DISCORD_TOKEN}}
      - CLIENT_ID=${PROD_CLIENT_ID:-${CLIENT_ID}}
      - CDN_BASE_URL=${PROD_CDN_BASE_URL:-${TEST_CDN_BASE_URL:-${CDN_BASE_URL:-https://cdn.gronka.p1x.dev/gifs}}}
      - SERVER_PORT=${PROD_SERVER_PORT:-${TEST_SERVER_PORT:-${SERVER_PORT:-3000}}}
      - GIF_STORAGE_PATH=${PROD_GIF_STORAGE_PATH:-./data-prod/gifs}
      - MAX_GIF_WIDTH=${PROD_MAX_GIF_WIDTH:-${TEST_MAX_GIF_WIDTH:-${MAX_GIF_WIDTH:-}}}
      - MAX_GIF_DURATION=${PROD_MAX_GIF_DURATION:-${TEST_MAX_GIF_DURATION:-${MAX_GIF_DURATION:-30}}}
      - DEFAULT_FPS=${PROD_DEFAULT_FPS:-${TEST_DEFAULT_FPS:-${DEFAULT_FPS:-}}}
      - MAX_VIDEO_SIZE=${PROD_MAX_VIDEO_SIZE:-${TEST_MAX_VIDEO_SIZE:-${MAX_VIDEO_SIZE:-}}}
      - MAX_IMAGE_SIZE=${PROD_MAX_IMAGE_SIZE:-${TEST_MAX_IMAGE_SIZE:-${MAX_IMAGE_SIZE:-}}}
      - GIF_QUALITY=${PROD_GIF_QUALITY:-${TEST_GIF_QUALITY:-${GIF_QUALITY:-medium}}}
      - ADMIN_USER_IDS=${PROD_ADMIN_USER_IDS:-${TEST_ADMIN_USER_IDS:-${ADMIN_USER_IDS:-}}}
      - STATS_USERNAME=${PROD_STATS_USERNAME:-${TEST_STATS_USERNAME:-${STATS_USERNAME:-}}}
      - STATS_PASSWORD=${PROD_STATS_PASSWORD:-${TEST_STATS_PASSWORD:-${STATS_PASSWORD:-}}}
      - STATS_CACHE_TTL=${PROD_STATS_CACHE_TTL:-${TEST_STATS_CACHE_TTL:-${STATS_CACHE_TTL:-}}}
      - COBALT_API_URL=${PROD_COBALT_API_URL:-${TEST_COBALT_API_URL:-${COBALT_API_URL:-http://cobalt:9000}}}
      - COBALT_ENABLED=${PROD_COBALT_ENABLED:-${TEST_COBALT_ENABLED:-${COBALT_ENABLED:-true}}}
      - R2_ACCOUNT_ID=${PROD_R2_ACCOUNT_ID:-${TEST_R2_ACCOUNT_ID:-${R2_ACCOUNT_ID:-}}}
      - R2_ACCESS_KEY_ID=${PROD_R2_ACCESS_KEY_ID:-${TEST_R2_ACCESS_KEY_ID:-${R2_ACCESS_KEY_ID:-}}}
      - R2_SECRET_ACCESS_KEY=${PROD_R2_SECRET_ACCESS_KEY:-${TEST_R2_SECRET_ACCESS_KEY:-${R2_SECRET_ACCESS_KEY:-}}}
      - R2_BUCKET_NAME=${PROD_R2_BUCKET_NAME:-${TEST_R2_BUCKET_NAME:-${R2_BUCKET_NAME:-}}}
      - R2_PUBLIC_DOMAIN=${PROD_R2_PUBLIC_DOMAIN:-${TEST_R2_PUBLIC_DOMAIN:-${R2_PUBLIC_DOMAIN:-cdn.gronka.p1x.dev}}}
      - R2_TEMP_UPLOADS_ENABLED=${PROD_R2_TEMP_UPLOADS_ENABLED:-${TEST_R2_TEMP_UPLOADS_ENABLED:-${R2_TEMP_UPLOADS_ENABLED:-}}}
      - R2_TEMP_UPLOAD_TTL_HOURS=${PROD_R2_TEMP_UPLOAD_TTL_HOURS:-${TEST_R2_TEMP_UPLOAD_TTL_HOURS:-${R2_TEMP_UPLOAD_TTL_HOURS:-}}}
      - R2_CLEANUP_ENABLED=${PROD_R2_CLEANUP_ENABLED:-${TEST_R2_CLEANUP_ENABLED:-${R2_CLEANUP_ENABLED:-}}}
      - R2_CLEANUP_INTERVAL_MS=${PROD_R2_CLEANUP_INTERVAL_MS:-${TEST_R2_CLEANUP_INTERVAL_MS:-${R2_CLEANUP_INTERVAL_MS:-}}}
      - R2_CLEANUP_LOG_LEVEL=${PROD_R2_CLEANUP_LOG_LEVEL:-${TEST_R2_CLEANUP_LOG_LEVEL:-${R2_CLEANUP_LOG_LEVEL:-}}}
      - NTFY_TOPIC=${PROD_NTFY_TOPIC:-${TEST_NTFY_TOPIC:-${NTFY_TOPIC:-}}}
      - CLOUDFLARE_API_TOKEN=${PROD_CLOUDFLARE_API_TOKEN:-${CLOUDFLARE_API_TOKEN:-}}
      - CLOUDFLARE_ACCOUNT_ID=${PROD_CLOUDFLARE_ACCOUNT_ID:-${CLOUDFLARE_ACCOUNT_ID:-}}
      - CLOUDFLARE_KV_NAMESPACE_ID=${PROD_CLOUDFLARE_KV_NAMESPACE_ID:-${CLOUDFLARE_KV_NAMESPACE_ID:-}}
      - CLOUDFLARE_PAGES_PROJECT_NAME=${PROD_CLOUDFLARE_PAGES_PROJECT_NAME:-${CLOUDFLARE_PAGES_PROJECT_NAME:-}}
      - LOG_LEVEL=${PROD_LOG_LEVEL:-${TEST_LOG_LEVEL:-${LOG_LEVEL:-}}}
      - LOG_DIR=${PROD_LOG_DIR:-${TEST_LOG_DIR:-${LOG_DIR:-}}}
      - LOG_ROTATION=${PROD_LOG_ROTATION:-${TEST_LOG_ROTATION:-${LOG_ROTATION:-}}}
      - SERVER_HOST=${PROD_SERVER_HOST:-${TEST_SERVER_HOST:-${SERVER_HOST:-}}}
      - WEBUI_PORT=${PROD_WEBUI_PORT:-${TEST_WEBUI_PORT:-${WEBUI_PORT:-3001}}}
      - WEBUI_HOST=${PROD_WEBUI_HOST:-${TEST_WEBUI_HOST:-${WEBUI_HOST:-0.0.0.0}}}
      - POSTGRES_HOST=${PROD_POSTGRES_HOST:-${TEST_POSTGRES_HOST:-${POSTGRES_HOST:-postgres}}}
      - POSTGRES_PORT=${PROD_POSTGRES_PORT:-${TEST_POSTGRES_PORT:-${POSTGRES_PORT:-5432}}}
      - POSTGRES_USER=${PROD_POSTGRES_USER:-${TEST_POSTGRES_USER:-${POSTGRES_USER:-gronka}}}
      - POSTGRES_PASSWORD=${PROD_POSTGRES_PASSWORD:-${TEST_POSTGRES_PASSWORD:-${POSTGRES_PASSWORD:-gronka}}}
      - POSTGRES_DB=${PROD_POSTGRES_DB:-${TEST_POSTGRES_DB:-${POSTGRES_DB:-gronka}}}
      - DATABASE_URL=${PROD_DATABASE_URL:-${TEST_DATABASE_URL:-${DATABASE_URL:-}}}
    volumes:
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - '${PROD_SERVER_PORT:-${TEST_SERVER_PORT:-${SERVER_PORT:-3000}}}:${PROD_SERVER_PORT:-${TEST_SERVER_PORT:-${SERVER_PORT:-3000}}}'
      - '${PROD_WEBUI_PORT:-${TEST_WEBUI_PORT:-${WEBUI_PORT:-3001}}}:${PROD_WEBUI_PORT:-${TEST_WEBUI_PORT:-${WEBUI_PORT:-3001}}}'
    networks:
      - gronka-network
    healthcheck:
      test: ['CMD-SHELL', 'pgrep -f "node.*src/bot.js" > /dev/null || exit 1']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  postgres:
    image: postgres:16-alpine
    container_name: gronka-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${PROD_POSTGRES_USER:-${TEST_POSTGRES_USER:-${POSTGRES_USER:-gronka}}}
      - POSTGRES_PASSWORD=${PROD_POSTGRES_PASSWORD:-${TEST_POSTGRES_PASSWORD:-${POSTGRES_PASSWORD:-gronka}}}
      - POSTGRES_DB=${PROD_POSTGRES_DB:-${TEST_POSTGRES_DB:-${POSTGRES_DB:-gronka}}}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - '${PROD_POSTGRES_PORT:-${TEST_POSTGRES_PORT:-${POSTGRES_PORT:-5432}}}:5432'
    networks:
      - gronka-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-gronka} -d ${POSTGRES_DB:-gronka}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  cobalt:
    image: ghcr.io/imputnet/cobalt:11
    init: true
    read_only: true
    restart: unless-stopped
    container_name: cobalt
    ports:
      # Exposed for internal Docker network access
      # If you want to restrict to localhost only, use: - 127.0.0.1:9000:9000/tcp
      - 9000:9000/tcp
    environment:
      # Replace with your public API URL if you have one, or leave as internal Docker network URL
      # For internal use only, this can be http://cobalt:9000
      API_URL: ${PROD_COBALT_API_URL:-${TEST_COBALT_API_URL:-${COBALT_API_URL:-http://cobalt:9000}}}
      # Path to cookies.json file for authenticating with services (Twitter, Instagram, Reddit, etc.)
      # Required for accessing content that requires authentication
      COOKIE_PATH: '/cookies.json'
    labels:
      - com.centurylinklabs.watchtower.scope=cobalt
    networks:
      - gronka-network
    volumes:
      # Mount cookies.json from project root to enable authentication for restricted content
      # Create cookies.json from cookies.example.json and add your service authentication cookies
      - ./cookies.json:/cookies.json

  giflossy:
    image: dylanninin/giflossy:latest
    container_name: giflossy
    restart: unless-stopped
    volumes:
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
    networks:
      - gronka-network
    # Note: This service is used for GIF optimization via docker exec

  # watchtower updates the cobalt image automatically
  watchtower:
    image: ghcr.io/containrrr/watchtower:latest
    restart: unless-stopped
    command: --cleanup --scope cobalt --interval 900 --include-restarting
    environment:
      - DOCKER_API_VERSION=1.52
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - gronka-network

  # if needed, use this image for automatically generating poToken & visitor_data
  # yt-session-generator:
  #   image: ghcr.io/imputnet/yt-session-generator:webserver
  #   init: true
  #   restart: unless-stopped
  #   container_name: yt-session-generator
  #   labels:
  #     - com.centurylinklabs.watchtower.scope=cobalt
  #   networks:
  #     - gronka-network

volumes:
  postgres-data:
    driver: local

networks:
  gronka-network:
    driver: bridge
