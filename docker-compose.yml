services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        GIT_COMMIT: ${GIT_COMMIT:-}
    container_name: gronka
    restart: unless-stopped
    environment:
      - DISCORD_TOKEN=${PROD_DISCORD_TOKEN:-${DISCORD_TOKEN}}
      - CLIENT_ID=${PROD_CLIENT_ID:-${CLIENT_ID}}
      - CDN_BASE_URL=${CDN_BASE_URL:-https://cdn.gronka.p1x.dev/gifs}
      - SERVER_PORT=3000
      - GRONKA_DB_PATH=${PROD_GRONKA_DB_PATH:-./data-prod/gronka.db}
      - GIF_STORAGE_PATH=${PROD_GIF_STORAGE_PATH:-./data-prod/gifs}
      - MAX_GIF_WIDTH=${MAX_GIF_WIDTH:-720}
      - MAX_GIF_DURATION=${MAX_GIF_DURATION:-30}
      - DEFAULT_FPS=${DEFAULT_FPS:-30}
      - ADMIN_USER_IDS=${ADMIN_USER_IDS:-}
      - STATS_USERNAME=${STATS_USERNAME:-}
      - STATS_PASSWORD=${STATS_PASSWORD:-}
      - COBALT_API_URL=${COBALT_API_URL:-http://cobalt:9000}
      - COBALT_ENABLED=${COBALT_ENABLED:-true}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-}
      - R2_PUBLIC_DOMAIN=${R2_PUBLIC_DOMAIN:-cdn.gronka.p1x.dev}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - WEBUI_PORT=3001
      - WEBUI_HOST=0.0.0.0
      - MAIN_SERVER_URL=http://localhost:3000
    volumes:
      - ./data:/app/data
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - '3000:3000'
      - '3001:3001'
    networks:
      - gronka-network
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  cobalt:
    image: ghcr.io/imputnet/cobalt:11
    init: true
    read_only: true
    restart: unless-stopped
    container_name: cobalt
    ports:
      # Exposed for internal Docker network access
      # If you want to restrict to localhost only, use: - 127.0.0.1:9000:9000/tcp
      - 9000:9000/tcp
    environment:
      # Replace with your public API URL if you have one, or leave as internal Docker network URL
      # For internal use only, this can be http://cobalt:9000
      API_URL: ${COBALT_API_URL:-http://cobalt:9000}
      # Path to cookies.json file for authenticating with services (Twitter, Instagram, Reddit, etc.)
      # Required for accessing content that requires authentication
      COOKIE_PATH: '/cookies.json'
    labels:
      - com.centurylinklabs.watchtower.scope=cobalt
    networks:
      - gronka-network
    volumes:
      # Mount cookies.json from project root to enable authentication for restricted content
      # Create cookies.json from cookies.example.json and add your service authentication cookies
      - ./cookies.json:/cookies.json

  giflossy:
    image: dylanninin/giflossy:latest
    container_name: giflossy
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
    networks:
      - gronka-network
    # Note: This service is used for GIF optimization via docker exec

  # watchtower updates the cobalt image automatically
  watchtower:
    image: ghcr.io/containrrr/watchtower:latest
    restart: unless-stopped
    command: --cleanup --scope cobalt --interval 900 --include-restarting
    environment:
      - DOCKER_API_VERSION=1.52
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - gronka-network

  # if needed, use this image for automatically generating poToken & visitor_data
  # yt-session-generator:
  #   image: ghcr.io/imputnet/yt-session-generator:webserver
  #   init: true
  #   restart: unless-stopped
  #   container_name: yt-session-generator
  #   labels:
  #     - com.centurylinklabs.watchtower.scope=cobalt
  #   networks:
  #     - gronka-network

networks:
  gronka-network:
    driver: bridge
