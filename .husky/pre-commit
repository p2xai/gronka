#!/usr/bin/env bash
set -e

# Allow skipping hooks with environment variable
if [ "$SKIP_HOOKS" = "1" ]; then
  echo "Skipping git hooks (SKIP_HOOKS=1)"
  exit 0
fi

# Detect WSL (Linux kernel + Windows paths)
if grep -qi "microsoft" /proc/version 2>/dev/null; then
  IS_WSL=1
else
  IS_WSL=0
fi

# Ensure PATH includes common *nix node locations
# Don't source .bashrc as it may contain bash-specific commands that fail in /bin/sh
export PATH="$PATH:/usr/local/bin:/opt/homebrew/bin:$HOME/.local/bin"

# If node is still not found, try Windows Node path under WSL
if ! command -v node >/dev/null 2>&1; then
  if [ "$IS_WSL" -eq 1 ]; then
    # Typical Windows Node path as seen in your PATH
    WIN_NODE_DIR="/mnt/c/Program Files/nodejs"
    if [ -x "$WIN_NODE_DIR/node.exe" ]; then
      export PATH="$PATH:$WIN_NODE_DIR"
    fi
  fi
fi

# Try nvm if still no node
if ! command -v node >/dev/null 2>&1; then
  if [ -s "$HOME/.nvm/nvm.sh" ]; then
    export NVM_DIR="$HOME/.nvm"
    # shellcheck disable=SC1090
    . "$NVM_DIR/nvm.sh"
  fi
fi

# Final check: if no node, skip hook instead of failing commit
if ! command -v node >/dev/null 2>&1; then
  echo "husky pre-commit: 'node' not found in PATH, skipping checks."
  exit 0
fi

# Use project-local npm from node_modules/.bin if possible
if [ -x "./node_modules/.bin/npm" ]; then
  NPM_CMD="./node_modules/.bin/npm"
else
  NPM_CMD="npm"
fi

# Get staged files (Added, Copied, Modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

# Exit early if no files are staged
if [ -z "$STAGED_FILES" ]; then
  echo "No files staged, skipping checks"
  exit 0
fi

# Check if package files are staged
PACKAGE_FILES_STAGED=false
if echo "$STAGED_FILES" | grep -qE "^(package\.json|package-lock\.json)$"; then
  PACKAGE_FILES_STAGED=true
fi

# Filter staged files for ESLint (JavaScript/TypeScript only, excluding .svelte)
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|cjs|mjs)$' || true)

# Filter staged files for Prettier (common supported formats)
PRETTIER_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|cjs|mjs|json|css|scss|html|md|yml|yaml)$' || true)

# Run check:sync only if package files are staged
if [ "$PACKAGE_FILES_STAGED" = true ]; then
  $NPM_CMD run check:sync
fi

# Run ESLint only if there are JavaScript/TypeScript files staged
if [ -n "$JS_FILES" ]; then
  # Convert newline-separated list to space-separated and run eslint
  JS_FILE_ARGS=$(echo "$JS_FILES" | tr '\n' ' ')
  echo "Running ESLint with auto-fix on staged files..."
  if [ -x "./node_modules/.bin/eslint" ]; then
    # Try to auto-fix issues first
    ./node_modules/.bin/eslint --fix $JS_FILE_ARGS || true
    # Then check for remaining issues (fail only on unfixable errors)
    ./node_modules/.bin/eslint --max-warnings=0 $JS_FILE_ARGS
  else
    # Try to auto-fix issues first
    npx eslint --fix $JS_FILE_ARGS || true
    # Then check for remaining issues (fail only on unfixable errors)
    npx eslint --max-warnings=0 $JS_FILE_ARGS
  fi
  # Stage any files that were auto-fixed (check for unstaged changes)
  echo "$JS_FILES" | while read -r file; do
    if [ -n "$file" ] && ! git diff --quiet "$file" 2>/dev/null; then
      # File has unstaged changes (was modified by eslint --fix), stage it
      git add "$file" 2>/dev/null || true
    fi
  done
else
  echo "No JavaScript/TypeScript files staged, skipping lint"
fi

# Run Prettier auto-fix only if there are prettier-supported files staged
if [ -n "$PRETTIER_FILES" ]; then
  # Convert newline-separated list to space-separated and run prettier
  PRETTIER_FILE_ARGS=$(echo "$PRETTIER_FILES" | tr '\n' ' ')
  echo "Running Prettier to auto-format staged files..."
  if [ -x "./node_modules/.bin/prettier" ]; then
    ./node_modules/.bin/prettier --write $PRETTIER_FILE_ARGS
  else
    npx prettier --write $PRETTIER_FILE_ARGS
  fi
  # Stage the formatted files
  echo "$PRETTIER_FILES" | while read -r file; do
    if [ -n "$file" ]; then
      git add "$file" 2>/dev/null || true
    fi
  done
  echo "Prettier formatting complete. Formatted files have been staged."
else
  echo "No prettier-supported files staged, skipping format check"
fi

# Validate Jekyll YAML front matter for blog posts (only when _posts/*.md files are staged)
JEKYLL_POSTS=$(echo "$STAGED_FILES" | grep -E '^_posts/.*\.md$' || true)

if [ -n "$JEKYLL_POSTS" ]; then
  echo "Validating Jekyll YAML front matter in blog posts..."
  JEKYLL_POST_ARGS=$(echo "$JEKYLL_POSTS" | tr '\n' ' ')
  if [ -x "./node_modules/.bin/node" ]; then
    node scripts/validate-jekyll-yaml.js $JEKYLL_POST_ARGS
  else
    $NPM_CMD run jekyll:validate -- $JEKYLL_POST_ARGS
  fi
fi
